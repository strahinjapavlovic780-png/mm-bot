import discord
from discord.ext import commands
import os
import json

VOUCH_FILE = "vouches.json"

if not os.path.exists(VOUCH_FILE):
    with open(VOUCH_FILE, "w") as f:
        json.dump({}, f)

def load_vouches():
    with open(VOUCH_FILE, "r") as f:
        return json.load(f)

def save_vouches(data):
    with open(VOUCH_FILE, "w") as f:
        json.dump(data, f, indent=4)

intents = discord.Intents.default()
intents.message_content = True
intents.guilds = True
intents.members = True

bot = commands.Bot(command_prefix="!", intents=intents, help_command=None)

CATEGORY_NAME = "â•â•ã€Œ ğŸ« TICKETS ã€â•â•"

MM_ROLE_ID = 1449366378732589107
MEMBER_ROLE_ID = 1449366374475497524
FOUNDER_ROLE_ID = 1449366341822845011
STAFF_CHANNEL_ID = 1449366415231553586
MERCY_ROLE_ID = 1453614120673738936
TICKET_CATEGORY_ID = None
# ================= READY =================

@bot.event
async def on_ready():
    bot.add_view(MMView())
    print(f"Logged in as {bot.user}")

# ================= PANEL SELECT =================

class MMSelect(discord.ui.Select):
    def __init__(self):
        options = [
            discord.SelectOption(label="ğŸ®In Game Items"),
            discord.SelectOption(label="ğŸª™Crypto"),
            discord.SelectOption(label="ğŸ’³Paypal"),
        ]

        super().__init__(
            placeholder="Select trade type below",
            min_values=1,
            max_values=1,
            options=options
        )

    async def callback(self, interaction: discord.Interaction):
        await interaction.response.send_modal(MMModal(self.values[0]))


class MMView(discord.ui.View):
    def __init__(self):
        super().__init__(timeout=None)
        self.add_item(MMSelect())

# ================= MODAL =================

class MMModal(discord.ui.Modal):
    def __init__(self, trade_type):
        super().__init__(title="Middleman Request")
        self.trade_type = trade_type

        self.other_user = discord.ui.TextInput(label="Other User (mention or ID)")
        self.trade_details = discord.ui.TextInput(
            label="Trade Details",
            style=discord.TextStyle.paragraph
        )
        self.agreement = discord.ui.TextInput(label="Did both agree?")

        self.add_item(self.other_user)
        self.add_item(self.trade_details)
        self.add_item(self.agreement)

    async def on_submit(self, interaction: discord.Interaction):

        guild = interaction.guild

        category = discord.utils.get(guild.categories, name=CATEGORY_NAME)
        if category is None:
            category = await guild.create_category(CATEGORY_NAME)

        mm_role = guild.get_role(MM_ROLE_ID)

        overwrites = {
            guild.default_role: discord.PermissionOverwrite(view_channel=False),
            interaction.user: discord.PermissionOverwrite(view_channel=True, send_messages=True),
        }

        # SAFE USER PARSE
        try:
            user_id = int(self.other_user.value.replace("<@", "").replace(">", "").replace("!", ""))
            other_member = await guild.fetch_member(user_id)

            overwrites[other_member] = discord.PermissionOverwrite(
                view_channel=True,
                send_messages=True
            )
        except:
            pass

        if mm_role:
            overwrites[mm_role] = discord.PermissionOverwrite(
                view_channel=True,
                send_messages=True
            )

        channel = await guild.create_text_channel(
            name=f"mm-{interaction.user.name}".lower().replace(" ", "-"),
            category=category,
            overwrites=overwrites
        )

        ticket_embed = discord.Embed(
            title="New Middleman Ticket",
            color=discord.Color.blue()
        )

        ticket_embed.add_field(name="Trade Type", value=self.trade_type, inline=False)
        ticket_embed.add_field(name="Other User", value=self.other_user.value, inline=False)
        ticket_embed.add_field(name="Trade Details", value=self.trade_details.value, inline=False)
        ticket_embed.add_field(name="Agreement", value=self.agreement.value, inline=False)

        await channel.send(
            content=f"{interaction.user.mention}",
            embed=ticket_embed,
            view=TicketButtons(interaction.user)
        )

        await interaction.response.send_message(
            f"Your ticket has been created: {channel.mention}",
            ephemeral=True
        )

# ================= BUTTONS =================

class TicketButtons(discord.ui.View):
    def __init__(self, creator):
        super().__init__(timeout=None)
        self.creator = creator
        self.claimer = None

    @discord.ui.button(label="Claim", style=discord.ButtonStyle.green)
    async def claim(self, interaction: discord.Interaction, button: discord.ui.Button):

        if MM_ROLE_ID not in [role.id for role in interaction.user.roles]:
            return await interaction.response.send_message(
                "Only MM team can claim tickets.",
                ephemeral=True
            )

        if self.claimer:
            return await interaction.response.send_message(
                "Ticket already claimed.",
                ephemeral=True
            )

        self.claimer = interaction.user
        button.disabled = True

        await interaction.response.edit_message(view=self)
        await interaction.channel.send(
            f"ğŸ”’ {interaction.user.mention} claimed this ticket."
        )

    @discord.ui.button(label="Add User", style=discord.ButtonStyle.blurple)
    async def add_user_btn(self, interaction: discord.Interaction, button: discord.ui.Button):

        if MM_ROLE_ID not in [role.id for role in interaction.user.roles]:
            return await interaction.response.send_message(
                "Only MM team can use this.",
                ephemeral=True
            )

        await interaction.response.send_message(
            "Use command: `!add @user`",
            ephemeral=True
        )

    @discord.ui.button(label="Remove User", style=discord.ButtonStyle.gray)
    async def remove_user_btn(self, interaction: discord.Interaction, button: discord.ui.Button):

        if MM_ROLE_ID not in [role.id for role in interaction.user.roles]:
            return await interaction.response.send_message(
                "Only MM team can use this.",
                ephemeral=True
            )

        await interaction.response.send_message(
            "Use command: `!remove @user`",
            ephemeral=True
        )

    @discord.ui.button(label="Close", style=discord.ButtonStyle.red)
    async def close(self, interaction: discord.Interaction, button: discord.ui.Button):

        if MM_ROLE_ID not in [role.id for role in interaction.user.roles]:
            return await interaction.response.send_message(
                "Only MM team can close tickets.",
                ephemeral=True
            )

        await interaction.response.send_message("Closing ticket...")
        await interaction.channel.delete()

# ================= COMMANDS =================

@bot.command()
async def add(ctx, member: discord.Member):
    if MM_ROLE_ID not in [role.id for role in ctx.author.roles]:
        return await ctx.send("Only MM team can use this command.")

    await ctx.channel.set_permissions(member, view_channel=True, send_messages=True)
    await ctx.send(f"{member.mention} added to ticket.")

@bot.command()
async def remove(ctx, member: discord.Member):
    if MM_ROLE_ID not in [role.id for role in ctx.author.roles]:
        return await ctx.send("Only MM team can use this command.")

    await ctx.channel.set_permissions(member, overwrite=None)
    await ctx.send(f"{member.mention} removed from ticket.")

@bot.command()
async def close(ctx):
    if MM_ROLE_ID not in [role.id for role in ctx.author.roles]:
        return await ctx.send("Only MM team can close tickets.")

    await ctx.send("Closing ticket...")
    await ctx.channel.delete()

# ================= PANEL COMMAND =================

@bot.command()
async def panel(ctx):

    embed = discord.Embed(
        title="Middleman Service",
        description=(
            "Welcome to our middleman service centre.\n\n"
            "At **Eneba**, we provide a safe and secure way to exchange your goods, "
            "whether it's in-game items, crypto or digital assets.\n\n"
            "Our trusted middleman team ensures that both parties receive exactly what they agreed upon "
            "with **zero risk of scams**.\n\n"
            "**If you've found a trade and want to ensure your safety, "
            "you can use our FREE middleman service by following the steps below.**\n\n"
            "*Note: Large trades may include a small service fee.*\n\n"
            "ğŸ“Œ **Usage Conditions**\n"
            "â€¢ Find someone to trade with.\n"
            "â€¢ Agree on the trade terms.\n"
            "â€¢ Click the dropdown below.\n"
            "â€¢ Wait for a staff member.\n\n"
            "**Eneba â€¢ Trusted Middleman Service**"
        ),
        color=discord.Color.blue()
    )

    await ctx.send(embed=embed, view=MMView())


# ================= HOW MM WORKS =================

@bot.command()
async def howmmworks(ctx):

    embed = discord.Embed(
        title="How a Middleman Works",
        description=(
            "ğŸ” **How Eneba's Middleman Service Works**\n\n"

            "Welcome to **Eneba's Middleman Service**, where your trades are handled with "
            "**maximum security, transparency, and professionalism**.\n\n"

            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            "ğŸ›¡ï¸ **Why Use a Middleman?**\n"
            "A middleman protects both parties during a trade. Instead of trusting a stranger, "
            "both users trust our verified MM team.\n\n"

            "With our service:\n"
            "â€¢ ğŸš« No scams\n"
            "â€¢ ğŸ”’ No risk of chargebacks\n"
            "â€¢ ğŸ¤ Fair trade guarantee\n"
            "â€¢ ğŸ“œ Proof and documentation of the deal\n\n"

            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            "ğŸ“© **Step-By-Step Process**\n"
            "1ï¸âƒ£ Both users agree on the trade terms.\n"
            "2ï¸âƒ£ Open a ticket and select the trade type.\n"
            "3ï¸âƒ£ Provide clear trade details inside the ticket.\n"
            "4ï¸âƒ£ An official MM team member will claim the ticket.\n"
            "5ï¸âƒ£ The buyer sends the payment/item to the MM.\n"
            "6ï¸âƒ£ After confirmation, the seller delivers their part.\n"
            "7ï¸âƒ£ Once both sides confirm, the MM safely releases the assets.\n\n"

            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            "ğŸŒŸ **Eneba's Middleman Service Guarantee**\n"
            "We ensure a **secure, neutral, and protected environment** for every trade.\n"
            "Our reputation is built on **trust, safety, and successful transactions**.\n\n"

            "ğŸ’œ Trade safely. Trade smart. Trade with confidence."
        ),
        color=discord.Color.blue()
    )

    embed.set_footer(text="Eneba | Official Middleman System")

    await ctx.send(embed=embed)

# ================= POLICY =================

@bot.command()
async def policy(ctx):

    embed = discord.Embed(
        title="Middleman Accountability & Compensation Policy",
        color=discord.Color.blue()
    )

    embed.add_field(
        name="1. Middleman Responsibility",
        value=(
            "Official middlemen must remain neutral and handle all assets fairly. "
            "Any misuse of authority or failure to return items is considered internal fraud."
        ),
        inline=False
    )

    embed.add_field(
        name="2. If a Middleman Scams",
        value=(
            "â€¢ Both traders will receive full compensation equal to their losses.\n"
            "â€¢ Compensation is provided by the Executive Team.\n"
            "â€¢ The middleman will be terminated, blacklisted, and permanently banned."
        ),
        inline=False
    )

    embed.add_field(
        name="3. Compensation Requirements",
        value=(
            "â€¢ Trade must occur inside our official Discord server.\n"
            "â€¢ The middleman must have had the MM role at the time.\n"
            "â€¢ Valid proof (screenshots/recordings) must be provided.\n\n"
            "**All official trades are fully protected under this policy.**"
        ),
        inline=False
    )

    embed.set_footer(text="Eneba | Protection Guaranteed")

    await ctx.send(embed=embed)




# ================= NEW CLAIM COMMAND =================

@bot.command()
async def claim(ctx):
    if MM_ROLE_ID not in [role.id for role in ctx.author.roles]:
        await ctx.send("Only MM team can claim tickets.")
        return

    await ctx.send(f"ğŸ”’ {ctx.author.mention} has claimed this ticket and is now handling this trade.")

# ================= FEE SYSTEM =================

class CustomFeeModal(discord.ui.Modal, title="Custom Fee Split"):

    split = discord.ui.TextInput(
        label="Enter split (example: 60-40)",
        placeholder="Example: 70-30",
        required=True
    )

    async def on_submit(self, interaction: discord.Interaction):

        try:
            parts = self.split.value.replace(" ", "").split("-")
            p1 = int(parts[0])
            p2 = int(parts[1])

            if p1 + p2 != 100:
                await interaction.response.send_message(
                    "Percentages must equal 100.",
                    ephemeral=True
                )
                return

        except:
            await interaction.response.send_message(
                "Invalid format. Use example: 60-40",
                ephemeral=True
            )
            return

        embed = discord.Embed(
            title=f"Middleman Fee Agreement â€“ {p1}/{p2} Split",
            description=(
                "Both traders have agreed to split the middleman fee equally.\n\n"
                f"**User 1 will pay {p1}% of the fee.**\n"
                f"**User 2 will pay {p2}% of the fee.**\n\n"
                "This ensures fairness and equal responsibility between both parties.\n\n"
                "Once payment is completed, the middleman will proceed with the secured transaction."
            ),
            color=discord.Color.blue()
        )

        await interaction.response.send_message(embed=embed)


class FeeView(discord.ui.View):
    def __init__(self, requester):
        super().__init__(timeout=None)
        self.requester = requester

    @discord.ui.button(label="50% / 50%", style=discord.ButtonStyle.primary)
    async def split_fee(self, interaction: discord.Interaction, button: discord.ui.Button):

        embed = discord.Embed(
            title="Middleman Fee Agreement â€“ 50/50 Split",
            description=(
                "Both traders have agreed to split the middleman fee equally.\n\n"
                "**Both users will pay 50% of the fee each.**\n\n"
                "This ensures fairness and equal responsibility between both parties.\n\n"
                "Once payment is completed, the middleman will proceed with the secured transaction."
            ),
            color=discord.Color.blue()
        )

        await interaction.response.send_message(embed=embed)

    @discord.ui.button(label="100% One User Pays", style=discord.ButtonStyle.red)
    async def full_fee(self, interaction: discord.Interaction, button: discord.ui.Button):

        embed = discord.Embed(
            title="Middleman Fee Agreement â€“ Full Payment",
            description=(
                f"{interaction.user.mention} has agreed to cover the full middleman fee.\n\n"
                f"**{interaction.user.mention} will pay 100% of the fees to the middleman.**\n\n"
                "The second trader is not responsible for any service fee in this transaction.\n\n"
                "Once the fee is confirmed, the trade will proceed under full protection."
            ),
            color=discord.Color.blue()
        )

        await interaction.response.send_message(embed=embed)

    @discord.ui.button(label="Custom Split", style=discord.ButtonStyle.secondary)
    async def custom_fee(self, interaction: discord.Interaction, button: discord.ui.Button):
        await interaction.response.send_modal(CustomFeeModal())


@bot.command()
async def fee(ctx):
    embed = discord.Embed(
        title="Middleman Service Fee Confirmation",
        description=(
            "To ensure transparency and fairness, all middleman transactions may include a service fee.\n\n"
            "Please choose how the fee will be handled for this trade:\n\n"
            "ğŸ”¹ **50% / 50% Split** â€“ Both users share the fee equally.\n"
            "ğŸ”¹ **100% One User Pays** â€“ One trader covers the entire fee.\n"
            "ğŸ”¹ **Custom Split** â€“ Choose your own percentage distribution.\n\n"
            "Click one of the buttons below to confirm how the fee will be paid."
        ),
        color=discord.Color.blue()
    )

    await ctx.send(embed=embed, view=FeeView(ctx.author))


# ================= CONFIRM SYSTEM =================

@bot.command()
async def confirm(ctx, user1: discord.Member, user2: discord.Member):
    embed = discord.Embed(
        title="Official Trade Confirmation",
        description=(
            "This trade has been officially confirmed under the supervision of our Middleman Team.\n\n"
            "Both parties listed below have agreed to the full trade terms, conditions, "
            "and fee structure associated with this transaction.\n\n"
            "By confirming this trade, both users acknowledge that:\n"
            "â€¢ The trade terms are final and mutually accepted.\n"
            "â€¢ The middleman will securely hold and transfer assets.\n"
            "â€¢ Any attempt of scam or chargeback will result in permanent ban.\n\n"
            "The transaction is now protected and logged under our official policy system.\n\n"
            "**Trade Protection Status: ACTIVE âœ…**"
        ),
        color=discord.Color.green()
    )

    embed.add_field(name="Trader 1", value=user1.mention, inline=False)
    embed.add_field(name="Trader 2", value=user2.mention, inline=False)
    embed.set_footer(text="Eneba | Secure Middleman Protection System")

    await ctx.send(embed=embed)

@bot.command()
async def help(ctx):
    embed = discord.Embed(
        title="ğŸ“˜ Enebas Bot Commands",
        description="Here is a list of all available commands",
        color=discord.Color.purple()
    )

    # ğŸŸ Ticket System
    embed.add_field(
        name="ğŸŸ Ticket System",
        value=(
            "`!panel` â€“ Sends the Middleman panel\n"
            "`!close` â€“ Closes the current ticket\n"
            "`!add @user` â€“ Add user to ticket\n"
            "`!remove @user` â€“ Remove user from ticket"
        ),
        inline=False
    )

    # ğŸ”’ Claim System
    embed.add_field(
        name="ğŸ”’ Claim System",
        value=(
            "`Claim Button` â€“ Claims ticket\n"
            "`Unclaim Button` â€“ Unclaims ticket"
        ),
        inline=False
    )

    # ğŸ’° Fee System
    embed.add_field(
        name="ğŸ’° Fee System",
        value=(
            "`!fee` â€“ Sends fee agreement\n"
            "`50/50 Button` â€“ Split fee\n"
            "`100% Button` â€“ One user pays full fee"
        ),
        inline=False
    )

    # âœ… Trade Confirmation
    embed.add_field(
        name="âœ… Trade Confirmation",
        value="`!confirm @user1 @user2` â€“ Confirms trade",
        inline=False
    )

    # â„¹ï¸ Information
    embed.add_field(
        name="â„¹ï¸ Information",
        value=(
            "`!howmmworks` â€“ Explains how MM works\n"
            "`!policy` â€“ Shows compensation policy"
        ),
        inline=False
    )

    # â­ Vouch Commands
    embed.add_field(
        name="â­ Vouch Commands",
        value=(
            "`!addvouch @user <amount>` â€“ Add vouches\n"
            "`!removevouch @user` â€“ Remove vouches\n"
            "`!vouches [@user]` â€“ Check vouches\n"
            "`!vouch @user` â€“ Add 1 vouch"
        ),
        inline=False
    )

    embed.set_footer(text="Enebas | Official Middleman Service")

    await ctx.send(embed=embed)


vouches = {}

def is_mm():
    async def predicate(ctx):
        role = discord.utils.get(ctx.author.roles, name="MM")
        if role is None:
            await ctx.send("You are not allowed to use this command.")
            return False
        return True
    return commands.check(predicate)

# ------------------------
# !addvouch <amount>
# ------------------------
@bot.command()
async def addvouch(ctx, amount: int):
    if amount <= 0:
        return await ctx.send("âŒ Please provide a valid positive number.")

    vouches = load_vouches()
    user_id = str(ctx.author.id)

    vouches[user_id] = vouches.get(user_id, 0) + amount
    save_vouches(vouches)

    embed = discord.Embed(
        title="â­ Vouch Added",
        description=f"{ctx.author.mention} now has **{vouches[user_id]}** vouches.",
        color=discord.Color.green()
    )

    await ctx.send(embed=embed)


# ------------------------
# !removevouch
# ------------------------
@bot.command()
async def removevouch(ctx):
    vouches = load_vouches()
    user_id = str(ctx.author.id)

    vouches[user_id] = 0
    save_vouches(vouches)

    embed = discord.Embed(
        title="ğŸ—‘ï¸ Vouches Removed",
        description=f"{ctx.author.mention}, all your vouches have been reset to **0**.",
        color=discord.Color.red()
    )

    await ctx.send(embed=embed)


# ------------------------
# !vouches [@user]
# ------------------------
@bot.command()
async def vouches(ctx, member: discord.Member = None):
    if member is None:
        member = ctx.author

    vouches_data = load_vouches()
    count = vouches_data.get(str(member.id), 0)

    embed = discord.Embed(
        title="â­ Vouch Count",
        description=f"{member.mention} currently has **{count}** vouches.",
        color=discord.Color.green()
    )

    embed.set_thumbnail(url=member.display_avatar.url)

    await ctx.send(embed=embed)


# ------------------------
# !vouch @user
# ------------------------
@bot.command()
async def vouch(ctx, member: discord.Member):
    if member == ctx.author:
        return await ctx.send("âŒ You cannot vouch for yourself.")

    vouches = load_vouches()
    user_id = str(member.id)

    vouches[user_id] = vouches.get(user_id, 0) + 1
    save_vouches(vouches)

    embed = discord.Embed(
        title="â­ New Vouch",
        description=f"{ctx.author.mention} vouched for {member.mention}\n\nThey now have **{vouches[user_id]}** vouches.",
        color=discord.Color.green()
    )

    embed.set_thumbnail(url=member.display_avatar.url)

    await ctx.send(embed=embed)
 
class MercyView(discord.ui.View):
    def __init__(self, target: discord.Member):
        super().__init__(timeout=60)
        self.target = target

    async def interaction_check(self, interaction: discord.Interaction):
        if interaction.user.id != self.target.id:
            await interaction.response.send_message(
                "âŒ You are not allowed to respond to this.",
                ephemeral=True
            )
            return False
        return True

    @discord.ui.button(label="Accept", style=discord.ButtonStyle.green)
    async def accept(self, interaction: discord.Interaction, button: discord.ui.Button):

        role = interaction.guild.get_role(MERCY_ROLE_ID)
        staff_channel = interaction.guild.get_channel(STAFF_CHANNEL_ID)

        if role:
            await self.target.add_roles(role)

        accept_embed = discord.Embed(
            description=(
                f"**{self.target.mention} has accepted the offer!**\n\n"
                "**What now?**\n"
                "â–¸ Check out and read all the staff channels carefully.\n"
                "â–¸ Once you have read them check your DMs for further guide.\n"
                "â–¸ Ask other staff for help if needed.\n\n"
                "**Start earning now!**"
            ),
            color=discord.Color.gold()
        )

        await interaction.channel.send(embed=accept_embed)

        if staff_channel:
            await staff_channel.send(embed=accept_embed)

        await interaction.response.send_message(
            "âœ… Offer accepted.",
            ephemeral=True
        )

        for item in self.children:
            item.disabled = True

        await interaction.message.edit(view=self)

    @discord.ui.button(label="Decline", style=discord.ButtonStyle.red)
    async def decline(self, interaction: discord.Interaction, button: discord.ui.Button):

        decline_embed = discord.Embed(
            description=(
                f"**{self.target.mention} has declined the offer!**\n\n"
                "**What now?**\n"
                "â–¸ Staff will review the situation.\n"
                "â–¸ You will not receive access to the Mercy program.\n\n"
                "**Decision recorded.**"
            ),
            color=discord.Color.gold()
        )

        await interaction.channel.send(embed=decline_embed)

        await interaction.response.send_message(
            "âŒ Offer declined.",
            ephemeral=True
        )

        for item in self.children:
            item.disabled = True

        await interaction.message.edit(view=self)

@bot.command()
async def mercy(ctx, member: discord.Member):

    
    embed = discord.Embed(
        title="Hitting Application",
        description="""â€¢ **We regret to inform you that you have been scammed**, and we sincerely apologize for this unfortunate situation.

However, there is a way for you to recover your losses and potentially earn 2x or even 100x if you're active.

â€¢ **What is Hitting?**
Hitting is where **you scam other people**, often using fake middlemans.
You can use our fake services that we provide to scam others and get tons of items.

Choose if you want to start hitting with us now.

Please click **accept or decline** to indicate your decision.
You have one minute to respond.

**The decision is yours. Make it count.**
""",
        color=discord.Color.blue()
    )
    await ctx.send(
    embed=embed,
    view=MercyView(member)
)
    
                            
                                                       
                                                
@bot.event
async def on_ready():
    print(f"Logged in as {bot.user}")

    # Persistent views (da dugmad rade i posle restarta)
    bot.add_view(MMView())
    bot.add_view(TicketButtons(None))
    bot.add_view(FeeView(None))

token = os.getenv("TOKEN")

if not token:
    raise ValueError("TOKEN environment variable is not set.")

bot.run(token)